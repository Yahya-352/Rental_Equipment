@model List<myproject_Library.Model.Notification>

@{
    ViewData["Title"] = "Notifications";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var unreadNotifications = Model.Where(n => n.Status == "Unread").ToList();
    var readNotifications = Model.Where(n => n.Status == "Read").ToList();
}

<h2>Notifications</h2>

<h3>Unread Notifications</h3>
@if (unreadNotifications.Any())
{
    <table class="table" id="unreadTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Message</th>
                <th>Type</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var notif in unreadNotifications)
            {
                <tr class="notificationRow" data-id="@notif.NotificationId" data-message="@notif.MessageContent" data-type="@notif.Type" data-status="@notif.Status">
                    <td>@notif.NotificationId</td>
                    <td>@notif.MessageContent</td>
                    <td>@notif.Type</td>
                    <td>@notif.Status <span class="gold-asterisk">*</span></td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No unread notifications.</p>
}

<h3>Read Notifications</h3>
@if (readNotifications.Any())
{
    <table class="table" id="readTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Message</th>
                <th>Type</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var notif in readNotifications)
            {
                <tr class="notificationRow" data-id="@notif.NotificationId" data-message="@notif.MessageContent" data-type="@notif.Type" data-status="@notif.Status">
                    <td>@notif.NotificationId</td>
                    <td>@notif.MessageContent</td>
                    <td>@notif.Type</td>
                    <td>@notif.Status</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No read notifications.</p>
}

<div id="notificationPopup" class="popup">
    <div class="popup-content">
        <span id="closePopup" class="close-btn">&times;</span>
        <h3>Notification Details</h3>
        <p><strong>ID:</strong> <span id="popupId"></span></p>
        <p><strong>Message:</strong> <span id="popupMessage"></span></p>
        <p><strong>Type:</strong> <span id="popupType"></span></p>
        <p><strong>Status:</strong> <span id="popupStatus"></span></p>
    </div>
</div>

<style>
    .popup {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .popup-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        width: 50%;
        max-width: 600px;
    }

    .close-btn {
        font-size: 30px;
        color: #aaa;
        float: right;
        cursor: pointer;
    }

        .close-btn:hover {
            color: black;
        }

    .gold-asterisk {
        color: gold;
        font-weight: bold;
    }

    .notificationRow {
        cursor: pointer;
    }

        .notificationRow:hover {
            background-color: #f1f1f1;
        }
</style>

<script>
    const modal = document.getElementById("notificationPopup");
    const closeBtn = document.getElementById("closePopup");

    const rows = document.querySelectorAll(".notificationRow");
    rows.forEach(function (row) {
        row.addEventListener("click", function () {
            const notifId = row.getAttribute("data-id");
            const notifMessage = row.getAttribute("data-message");
            const notifType = row.getAttribute("data-type");

            fetch('/Notification/MarkNotificationAsRead', {
                method: 'POST',
                body: JSON.stringify({ NotificationId: notifId }),
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("popupId").textContent = notifId;
                    document.getElementById("popupMessage").textContent = notifMessage;
                    document.getElementById("popupType").textContent = notifType;
                    document.getElementById("popupStatus").textContent = "Read";
                    modal.style.display = "flex";
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    closeBtn.addEventListener("click", function () {
        modal.style.display = "none";
        location.reload();
    });

    window.onclick = function (event) {
        if (event.target === modal) {
            modal.style.display = "none";
            location.reload();
        }
    };

    // Auto-open popup if ?selectedId= is in URL
    window.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedId = urlParams.get("selectedId");

        if (selectedId) {
            const row = document.querySelector(`.notificationRow[data-id="${selectedId}"]`);

            if (row) {
                const notifId = row.getAttribute("data-id");
                const notifMessage = row.getAttribute("data-message");
                const notifType = row.getAttribute("data-type");

                fetch('/Notification/MarkNotificationAsRead', {
                    method: 'POST',
                    body: JSON.stringify({ NotificationId: notifId }),
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("popupId").textContent = notifId;
                        document.getElementById("popupMessage").textContent = notifMessage;
                        document.getElementById("popupType").textContent = notifType;
                        document.getElementById("popupStatus").textContent = "Read";
                        modal.style.display = "flex";
                    }
                });
            }
        }
    });
</script>
